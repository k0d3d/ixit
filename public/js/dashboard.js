var app=angular.module("ixitApp",["ui.router","filters","directives","language","user","dashboard","services","ngResource","ngSanitize","ngCookies","flow"]);app.config(["$stateProvider","$urlRouterProvider","$httpProvider","flowFactoryProvider",function($stateProvider,$urlRouterProvider,$httpProvider,flowFactoryProvider){flowFactoryProvider.defaults={target:"http://localhost:3001/upload",chunkSize:1048576,simultaneousUploads:4,testChunks:!0,maxFiles:10,permanentErrors:[404,500,501],maxChunkRetries:1,chunkRetryInterval:5e3},flowFactoryProvider.on("progress",function(){}),flowFactoryProvider.on("error",function(){console.log(arguments)}),$urlRouterProvider.otherwise("/cabinet/files/all"),$httpProvider.interceptors.push("httpRequestInterceptor")}]),app.factory("httpRequestInterceptor",["$cookies","$window","$q","Alert",function($cookies,$window,$q,N){return{request:function($config){return $config.headers["x-Authr"]=$cookies.throne,$config},responseError:function(response){return 401===response.status?($window.location.href="/#/login",$q.reject(response)):(N.set_notice({message:response.data.message||response.data,type:"danger"}),$q.reject(response))}}}]),app.controller("MainController",["$scope","$http","$location","$rootScope","$cookies","Keeper","Tabs","Alert",function($scope,$http,$location,$rootScope,$cookies,Keeper,T,Alert){$scope.cuser=$cookies.throne,$scope.modal={heading:"",body:""},$scope.cabinetTabs=[],$scope.filequeue=[],$scope.path=[],$scope.commons={clearAll:function(){$scope.filequeue=""}},$scope.clickBrowse=function(){$(".browsefiles").click()},$scope.searchQuery=function(){Keeper.search($scope.queryString,function(d){T.createTab({title:$scope.queryString,id:$scope.queryString.replace(/[^\w\s]/gi,"")+"-tab",list:d.hits})})},$scope.$on("newTab",function(){$scope.cabinetTabs.push(T.tab)}),$scope.$on("reloadTab",function(){var index=_.findIndex($scope.cabinetTabs,{id:T.tab.id});0>index?$scope.cabinetTabs.push(T.tab):$scope.cabinetTabs[index]=T.tab}),$scope.$on("newPrompt",function(){$scope.alerts=Alert.prompts}),$scope.$on("newNotice",function(){$scope.notices=Alert.notes}),$scope.$on("refresh_breadcrumb",function(){$scope.path=Keeper.path}),$scope.$on("folder_change",function(){$scope.currentFolder=Keeper.currentFolder}),$scope.$on("$destroy",function(){$(window).off("resize.bnViewport")})}]),$(function(){$(document).bind("drop dragover",function(e){e.preventDefault()}),$(".bar-n-body").height($(".content").innerHeight()),$(window).on("resize",function(){$(".bar-n-body").height($(".content").innerHeight());var element=$(".tab-pane");$(element).slimScroll({destroy:!0});var elTop=$(element).offset().top,wrapHeight=$("#wrap").height();$(element).slimScroll({height:wrapHeight-elTop+"px"})})}),angular.module("dashboard",[]).config(["$stateProvider",function($stateProvider){$stateProvider.state("cabinet",{"abstract":!0,url:"/cabinet",views:{main:{templateUrl:"/dashboard/all",controller:"cabinetController"}}}).state("cabinet.files",{url:"/files/all",views:{"cabinetView@cabinet":{templateUrl:"/templates/dashboard/cabinet",controller:"indexController",resolve:{contenter:function($http,Keeper){return Keeper.openFolder({id:"home"})}}}}}).state("cabinet.folder",{url:"/folder/:folderId",views:{"cabinetView@cabinet":{templateUrl:"/templates/dashboard/cabinet",controller:"filesController",resolve:{contenter:function($stateParams,Keeper){return Keeper.openFolder({id:$stateParams.folderId})}}}}})}]).controller("cabinetController",["$scope","Keeper","Tabs","Alert",function($scope,Keeper,Tabs,Alert){$scope.create_folder=function(newFolderInput){return newFolderInput?void Keeper.createSubFolder(newFolderInput,$scope.$parent.currentFolder,function(r){$scope.cabinetTabs[0].list.folders.push(r)}):!1},$scope.trashFile=function(index,tabIndex){Alert.set_prompt({type:"info",message:"Confirm you really want to delete this?",exec:function(){var ixid=$scope.cabinetTabs[tabIndex].list.files[index].ixid;Keeper.deleteThisFile(ixid,function(){$scope.cabinetTabs[tabIndex].list.files.splice(index,1)})}})},$scope.trashFolder=function(index,tabIndex){Alert.set_prompt({type:"info",message:"Confirm you really want to delete this?",icon:"fa-trash-o",exec:function(){var ixid=$scope.cabinetTabs[tabIndex].list.folders[index].fid;Keeper.deleteThisFolder(ixid,function(){})}})}}]).controller("indexController",["$scope","$http","$cookies","$state","Tabs","contenter",function($scope,$http,$cookies,$state,Tabs,contenter){$scope.contenter=contenter,Tabs.reloadTab({title:"Home",id:"home-tab",list:$scope.contenter})}]).controller("filesController",["$scope","$http","Keeper","Tabs","contenter",function($scope,$http,Keeper,Tabs,contenter){console.log("files"),$scope.contenter=contenter,Tabs.reloadTab({title:"Home",id:"home-tab",list:$scope.contenter}),$scope.refresh_tab=function(index){console.log(index)},$scope.close_tab=function(index){console.log(index)},$scope.open_folder=function(){},$scope.up_folder=function(){},$scope.current_folder=Keeper.tab}]).controller("queueController",["$scope","$http","Keeper","Sharer",function($scope,$http,Keeper,Sharer){function init(){var param={user:$scope.cuser};Keeper.thisUserQueue(param,function(r){r===!1||_.isEmpty(r)||_.each(r,function(v){Sharer.queue(v)})}),$scope.uploadStateText="Resume",$scope.uploadStateClass="fa-play"}init(),$scope.toggleUpload=function(){$scope.$flow.isUploading()?($scope.uploadStateText="Resume",$scope.uploadStateClass="fa-play",$scope.$flow.pause()):($scope.uploadStateText="Pause",$scope.uploadStateClass="fa-pause",$scope.$flow.resume())},$scope.clear=function(e,mid,uid){if(e.preventDefault(),!_.isUndefined(Sharer.resumable)){var fileObj=Sharer.resumable.getFromUniqueIdentifier(uid);fileObj.cancel()}Keeper.removeFromQueue(mid,function(){Sharer.removeFromQueue(uid)})},$scope.clearAll=function(){$scope.$flow.cancel(),Sharer.cancel()},$scope.$on("onQueue",function(){$scope.filequeue=Sharer.filequeue}),$scope.$on("flow::fileSuccess",function(){var flowFile=arguments[2],pos=_.findIndex($scope.$flow.files,{uniqueIdentifier:flowFile.uniqueIdentifier});$scope.$flow.files.splice(pos,1)})}]).filter("formatFileSize",function(){return function(bytes){return"number"!=typeof bytes?"":bytes>=1e9?(bytes/1e9).toFixed(2)+" GB":bytes>=1e6?(bytes/1e6).toFixed(2)+" MB":(bytes/1e3).toFixed(2)+" KB"}}).filter("moment",function(){return function(time){var m=moment(time);return m.fromNow()}}),angular.module("home",[]).config(["$stateProvider",function($stateProvider){$stateProvider.state("home",{url:"/home",templateUrl:"/home/index",controller:"homeIndexController"})}]).controller("homeIndexController",function(){}),angular.module("user",[]).config(["$stateProvider",function($stateProvider){$stateProvider.state("login",{url:"/login",templateUrl:"/home/login",controller:"loginController"}).state("recover",{url:"/recover",templateUrl:"/home/recover",controller:"loginController"}).state("register",{url:"/register",templateUrl:"/home/register",controller:"registerController"})}]).controller("loginController",function($scope,$sanitize,$location,Authenticate,$timeout,$window){$scope.form={},$scope.flash="",$scope.login=function(){$scope.isLoading=!0,Authenticate.postParam({email:$sanitize($scope.form.email),password:$sanitize($scope.form.password)}).then(function(r){401===r.status||400===r.status?($scope.isLoading=!1,$scope.flash="Wrong username / password",$timeout(function(){$scope.flash=""},7e3)):200===r.status?$window.location=r.data.returnTo:($scope.isLoading=!1,$scope.flash="An Error Occured with the Authentication Request",$timeout(function(){$scope.flash=""},7e3))})}}).controller("registerController",function($scope,$sanitize,$location,$http,$timeout){$scope.form={},$scope.flash="",$scope.isRegistered=!1,$scope.signup=function(){$scope.isLoading=!0;var regData={username:$sanitize($scope.form.username),email:$sanitize($scope.form.email),password:$sanitize($scope.form.password)};$http.post("/api/internal/users",regData).success(function(){$scope.isRegistered=!0}).error(function(c){$scope.isLoading=!0,$scope.flash=c.errors.message,angular.forEach(c.errors.errors,function(value,key){$scope.registration_form[key].$error.taken=!0,$scope.registration_form[key].$invalid=!0}),$timeout(function(){$scope.flash=""},7e3)})}}).factory("accountServices",["$http","Notification","Language",function(http){var as={};return as.getUser=function(cb){http.get("/users/me").success(function(d){cb(d)}).error(function(){})},as.update=function(d){http.put("/users/me/",d).success(function(){}).error(function(){})},as}]).directive("validPasswordC",[function(){return{require:"ngModel",link:function(scope,elem,attrs,ctrl){var firstPassword="#"+attrs.validPasswordC;elem.add(firstPassword).on("keyup",function(){scope.$apply(function(){var v=elem.val()===$(firstPassword).val();ctrl.$setValidity("pwmatch",v)})})}}}]),angular.module("services",[]).factory("Authenticate",function($http){var a={};return a.postParam=function(loginParams){return $http.post("/api/internal/users/session",loginParams).then(function(d){return d},function(e){return e})},a.logout=function(){},a.getApiKey=function(cb){$http.get("/users/developer/apikey").success(function(data){cb(data)}).error(function(){})},a}).factory("Keeper",["$http","Alert","$rootScope","$cookies",function($http,Alert,$rootScope,$cookies){var a={};return a.currentFolder="",a.currentUser=$cookies.throne,a.path=[],a.addToCrumb=function(ob){a.path.push(ob),$rootScope.$broadcast("refresh_breadcrumb")},a.openFolder=function(folderParam){return $http.get("/api/internal/users/folder?"+$.param(folderParam)).then(function(list){return"home"!==folderParam.fid?a.addToCrumb({id:list.data.props.fid,name:list.data.props.name}):$rootScope.$broadcast("refresh_breadcrumb"),a.currentFolder=list.data.props.fid,$rootScope.$broadcast("folder_change"),list.data})},a.createSubFolder=function(name,parentId,cb){$http.post("/api/internal/users/folder",{name:name,parentId:parentId,type:"sub"}).success(function(r){cb(r)}).error(function(err){Alert.set_notice({message:err,type:"danger"})})},a.thisUserFiles=function(param,callback){$http.get("/api/internal/users/files",param).success(function(data){callback(data)}).error(function(data){console.log(data),callback(!1)})},a.thisUserQueue=function(param,callback){$http.get("/api/internal/users/queue",param).success(function(data){callback(data)}).error(function(data){console.log(data),callback(!1)})},a.deleteThisFile=function(ixid,callback){$http.delete("/api/internal/users/files/"+ixid).success(function(data){callback(data)}).error(function(){})},a.deleteThisFolder=function(folderId,callback){$http.delete("/api/internal/users/folder/"+folderId).success(function(data){callback(data)}).error(function(){})},a.removeFromQueue=function(mid,callback){$http.delete("/api/internal/users/queue/"+mid).success(function(){callback()}).error(function(){})},a.updateTags=function(tags,file_id){$http.put("/api/internal/users/files/"+file_id+"/tags",{tags:tags}).success(function(){}).error(function(){})},a.search=function(query,cb){$http.get("/api/search/"+query).success(function(d){cb(d)}).error(function(){})},a.makeFolder=function(){},a}]).factory("Sharer",function($rootScope){function isExistingFile(q,file){return q.identifier===file.uniqueIdentifier?!0:!1}var s={};return s.filequeue=[],s.warning=0,s.queue=function(r){this.filequeue.push(r),this.filequeue=_.flatten(this.filequeue),this.broadcastItem()},s.addToQueue=function(file){var self=this,notfound=!0,l=this.filequeue.length;l>0?(_.some(this.filequeue,function(v,i){return isExistingFile(v,file)?(notfound=!1,self.filequeue[i].isQueued="true",!0):void 0}),notfound===!0&&self.queue({filename:file.fileName,size:file.size,identifier:file.uniqueIdentifier})):this.queue({filename:file.fileName,size:file.size,identifier:file.uniqueIdentifier})},s.removeFromQueue=function(fileIdentifier){var position;_.some(this.filequeue,function(v,i){return v.identifier===fileIdentifier?(position=i,!0):void 0}),"number"==typeof position&&(this.filequeue.splice(position,1),this.broadcastItem())},s.cancel=function(){this.filequeue.length=0,this.broadcastItem()},s.broadcastItem=function(){$rootScope.$broadcast("onQueue")},s}).factory("Alert",["$rootScope","Language",function($rootScope,L){var s={},__state={success:{"class":"x-alert-success"},info:{"class":"x-alert-info"},danger:{"class":"x-alert-danger",heading:L.eng.error,icon:"fa-warning"}};return s.prompts=null,s.notes=null,s.set_prompt=function(n){this.prompts=n,this.prompts.heading=n.heading||"Are you sure",this.prompts.class=__state[n.type].class,this.prompts.icon=n.icon||__state[n.type].icon,this.broadcastPrompt()},s.set_notice=function(n){this.notes=n,this.notes.class=__state[n.type].class,this.notes.heading=__state[n.type].heading,this.notes.icon=__state[n.type].icon,this.broadcastNotice()},s.broadcastPrompt=function(){$rootScope.$broadcast("newPrompt")},s.broadcastNotice=function(){$rootScope.$broadcast("newNotice")},s}]).factory("Tabs",["$rootScope",function($rootScope){var s={};return s.tabs=[],s.tab=null,s.createTab=function(n){this.tab=n,this.reTab()},s.reloadTab=function(content){this.tab=content,this._reloadTab()},s._reloadTab=function(){$rootScope.$broadcast("reloadTab")},s.reTab=function(){$rootScope.$broadcast("newTab")},s.closeTab=function(){},s}]),angular.module("directives",[]);var appDirective=angular.module("directives");appDirective.directive("dragover",function(){return{link:function(scope,element,attrs){element.on("dragover dragenter",function(){$(attrs.dragover).show()}),element.on("dragleave",function(){$(attrs.dragover).hide()})}}}),appDirective.directive("scrollBar",function(){return{link:function(scope,element){scope.$watch(function(){var elTop=$(element).offset().top,wrapHeight=$("#wrap").height();wrapHeight>wrapHeight-elTop&&$(element).slimScroll({height:wrapHeight-elTop+"px"})})}}}),appDirective.directive("queueTip",function(){return{link:function(scope,element){element.tooltip({title:"This upload will be resumed"})}}}),appDirective.directive("loading",function(){return{link:link}}),appDirective.directive("profilephoto",function(){function link(scope,element){element.on("click",function(e){e.preventDefault(),$(".p-ph-h-i").click();var r=new Resumable({target:"/user/account/photo",chunkSize:1048576,simultaneousUploads:1,testChunks:!1,maxFiles:1,fileParameterName:"pp"});r.assignBrowse($(".p-ph-h-i")[0]),r.on("fileAdded",function(){r.upload()})}),element.on("mouseover",function(){$(this).after('<span class="label label-default animated fadeInUp">Click to change</span>')}),element.on("mouseout mouseleave",function(){element.next("span.label").remove()})}return{restrict:"EA",link:link}}),appDirective.directive("tagsInput",["Keeper",function(K){function link(scope,element,attrs){$(element).tagsInput(),scope.$watch(attrs.ngModel,function(n){return _.isUndefined(n)?!1:void $(element).importTags(n)});var id=$(element).attr("id");$("#"+id+"_tag").on("focusout",function(){var tgs=$(element).val();if(0===tgs.length)return!1;var file_id=attrs.ixid;K.updateTags(tgs,file_id,function(){})})}return{link:link}}]),appDirective.directive("dropdownHover",function(){function link(scope,element){$(element).dropdownHover()}return{link:link}}),appDirective.directive("activateTab",function($timeout){function link(scope){scope.$last===!0&&$timeout(function(){var lnt=scope.cabinetTabs.length-1,lastTab=scope.cabinetTabs[lnt].id;$('a.title[data-target="#'+lastTab+'"]').tab("show")})}return{link:link}}),appDirective.directive("folderTabs",function(){function link(){}return{link:link,templateUrl:"/templates/cabinet-tabs-tpl.jade"}}),appDirective.directive("notification",["$timeout",function($timeout){function link(scope){function _queueNote(n){scope.notes.push(n),$timeout(function(){scope.close_note(0)},1e4)}scope.notes=[],scope.$watch("notices",function(n){_.isEmpty(n)||_queueNote(n)})}function NoticeCtrl($scope){$scope.close_note=function(index){$scope.notes.splice(index,1)}}return{link:link,templateUrl:"/templates/notice-alert-tpl",scope:{notices:"=notification"},controller:NoticeCtrl}}]),appDirective.directive("prompt",[function(){function _close(index,arr){arr.splice(index,1)}function link(scope){function _queueAlert(n){scope.a_p.push(n)}scope.a_p=[],scope.$watch("prompts",function(n){_.isEmpty(n)||_queueAlert(n)})}function AlertCtrl($scope){$scope.close_an=function(index){_close(index,$scope.a_p)},$scope.exec_yes=function(index){$scope.a_p[index].exec(),_close(index,$scope.a_p)}}return{link:link,templateUrl:"/templates/prompt-alert-tpl",scope:{prompts:"=prompt"},controller:AlertCtrl}}]),angular.module("filters",[]),angular.module("language",[]).constant("Language",{eng:{error:"Yikes",success:"Yippie",info:"Hmmn"}}),$(function(){$(".notification-dropdown").each(function(index,el){var $el=$(el),$dialog=$el.find(".pop-dialog"),$trigger=$el.find(".trigger");$dialog.click(function(e){e.stopPropagation()}),$dialog.find(".close-icon").click(function(e){e.preventDefault(),$dialog.removeClass("is-visible"),$trigger.removeClass("active")}),$("body").click(function(){$dialog.removeClass("is-visible"),$trigger.removeClass("active")}),$trigger.click(function(e){e.preventDefault(),e.stopPropagation(),$(".notification-dropdown .pop-dialog").removeClass("is-visible"),$(".notification-dropdown .trigger").removeClass("active"),$dialog.toggleClass("is-visible"),$dialog.hasClass("is-visible")?$(this).addClass("active"):$(this).removeClass("active")})}),$(".skins-nav .skin").click(function(e){if(e.preventDefault(),!$(this).hasClass("selected")){$(".skins-nav .skin").removeClass("selected"),$(this).addClass("selected"),$("#skin-file").length||$("head").append('<link rel="stylesheet" type="text/css" id="skin-file" href="">');var $skin=$("#skin-file");$(this).attr("data-file")?$skin.attr("href",$(this).data("file")):$skin.attr("href","")}}),$("#dashboard-menu .dropdown-toggle").click(function(e){e.preventDefault();var $item=$(this).parent();$item.toggleClass("active"),$item.hasClass("active")?$item.find(".submenu").slideDown("fast"):$item.find(".submenu").slideUp("fast")});var $menu=$("#sidebar-nav");$("body").click(function(){$menu.hasClass("display")&&$menu.removeClass("display")}),$menu.click(function(e){e.stopPropagation()}),$("#menu-toggler").click(function(e){e.stopPropagation(),$menu.toggleClass("display")}),$("[data-toggle='tooltip']").each(function(index,el){$(el).tooltip({placement:$(this).data("placement")||"top"})});var uiDropdown=new function(){var self;return self=this,this.hideDialog=function($el){return $el.find(".dialog").hide().removeClass("is-visible")},this.showDialog=function($el){return $el.find(".dialog").show().addClass("is-visible")},this.initialize=function(){return $("html").click(function(){return $(".ui-dropdown .head").removeClass("active"),self.hideDialog($(".ui-dropdown"))}),$(".ui-dropdown .body").click(function(e){return e.stopPropagation()}),$(".ui-dropdown").each(function(index,el){return $(el).click(function(e){return e.stopPropagation(),$(el).find(".head").toggleClass("active"),$(el).find(".head").hasClass("active")?self.showDialog($(el)):self.hideDialog($(el))})})}};new uiDropdown,$(".table th input:checkbox").click(function(){$checks=$(this).closest(".table").find("tbody input:checkbox"),$(this).is(":checked")?$checks.prop("checked",!0):$checks.prop("checked",!1)})});